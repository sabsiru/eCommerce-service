# 결제 API 명세서

## 1. 개요
- 사용자가 주문을 결제하는 API입니다.
- 결제는 기 충전된 잔액을 통해 이루어지며, 결제 완료 후 주문 상태가 변경됩니다.

---

## 2. API 정보

| 항목         | 내용                                                                   |
|--------------|----------------------------------------------------------------------|
| API 명칭     | 결제 API                                                               |
| 설명         | 사용자가 주문을 결제하는 기능입니다. 결제 시 기 충전된 잔액을 통해 결제하며, 결제 완료 후 주문 상태를 업데이트합니다. |
| 관련 도메인  | Order, User, BalanceHistory, Coupon, OrderItem                       |

---

## 3. 요청

- Method: `POST`
- Endpoint: `/order/{orderId}/payment`

#### 3.1 Path Variable

| 변수명   | 타입   | 필수   | 설명                                   |
|----------|--------|--------|----------------------------------------|
| orderId  | Long   | ✅     | 결제를 진행할 주문의 ID               |

#### 3.2 Request Body

{
  "paymentMethod": "balance",  // 결제 방법: balance (잔액 결제)
  "couponId": 12345            // 사용할 쿠폰 ID (옵션)
}

| 필드명        | 타입   | 필수   | 설명                                         |
|---------------|--------|--------|----------------------------------------------|
| paymentMethod | String | ✅     | 결제 방법 ("balance"로만 지정 가능)          |
| couponId      | Long   | ❌     | 결제 시 사용할 쿠폰 ID (선택, 사용시 제공)    |

---

## 4. 응답

#### 4.1 성공 시

{
  "message": "결제가 완료되었습니다.",
  "orderId": 12345,
  "status": "PAID",
  "totalAmount": 5000,
  "remainingBalance": 15000
}

| 필드명         | 타입   | 설명                                      |
|----------------|--------|-------------------------------------------|
| message        | String | 결제 완료 메시지                          |
| orderId        | Long   | 결제된 주문의 ID                          |
| status         | String | 주문 상태 ("PAID")                        |
| totalAmount    | Int    | 결제된 총 금액                            |
| remainingBalance | Int  | 결제 후 남은 잔액                         |

#### 4.2 상태 코드

| 코드 | 설명           |
|------|----------------|
| 200  | 결제 성공       |
| 400  | 잘못된 요청     |
| 404  | 사용자 없음     |
| 409  | 잔액 부족        |

---

## 5. 예외 처리

| 예외 상황                | HTTP 상태 | 설명                                                                 |
|-------------------------|------------|----------------------------------------------------------------------|
| 사용자 ID 누락 또는 오류 | 400        | URI 경로에 orderId가 없거나 유효하지 않은 경우                          |
| 결제 금액 부족           | 400        | 사용자의 잔액이 부족한 경우                                           |
| 상품 재고 부족           | 409        | 결제하려는 상품의 재고가 부족한 경우                                  |
| 쿠폰 유효성 오류         | 400        | 쿠폰이 유효하지 않거나 이미 사용된 쿠폰인 경우                        |

---

## 6. 테스트 포인트

| 테스트 항목             | 검증 내용                                                       |
|------------------------|------------------------------------------------------------------|
| 사용자 ID 식별 처리      | 요청에 포함된 userId가 정확히 식별되어 처리되는가                  |
| 잔액 부족 처리           | 사용자의 잔액이 부족한 경우 400 응답이 반환되는가                  |
| 정상 결제 처리           | 유효한 결제 금액 입력 시 결제 완료되며 주문 상태가 "PAID"로 변경되는가 |
| 재고 부족 처리           | 상품의 재고가 부족할 경우 409 응답이 반환되는가                     |
| 쿠폰 유효성 처리         | 유효한 쿠폰만 사용될 수 있으며, 유효하지 않은 쿠폰은 예외를 발생시키는가 |
| 결제 기록 저장 확인      | 결제 후 결제 기록이 정상적으로 저장되는가                          |

[돌아가기](../../README.md)